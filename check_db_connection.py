
# check_db_connection.py
import os
import psycopg2
from dotenv import load_dotenv

print("--- –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î ---")

# 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env
print("\n1. –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞ .env...")
if not load_dotenv():
    print("‚ùå –û–®–ò–ë–ö–ê: –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω! –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ–Ω –ª–µ–∂–∏—Ç –≤ —ç—Ç–æ–π –∂–µ –ø–∞–ø–∫–µ.")
    exit()
print("‚úÖ –§–∞–π–ª .env –Ω–∞–π–¥–µ–Ω –∏ –∑–∞–≥—Ä—É–∂–µ–Ω.")

# 2. –ß–∏—Ç–∞–µ–º DATABASE_URL
db_url = os.getenv("DATABASE_URL")
print("\n2. –ß–∏—Ç–∞–µ–º —Å—Ç—Ä–æ–∫—É –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (DATABASE_URL)...")
if not db_url:
    print("‚ùå –û–®–ò–ë–ö–ê: –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è DATABASE_URL –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Ñ–∞–π–ª–µ .env!")
    exit()

# –ú–∞—Å–∫–∏—Ä—É–µ–º –ø–∞—Ä–æ–ª—å –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –≤—ã–≤–æ–¥–∞ –≤ –∫–æ–Ω—Å–æ–ª—å
try:
    user_part = db_url.split('@')[0].split('//')[1].split(':')[0]
    host_part = db_url.split('@')[1]
    masked_url = f"postgresql://{user_part}:*****@{host_part}"
    print(f"‚úÖ –°—Ç—Ä–æ–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –Ω–∞–π–¥–µ–Ω–∞: {masked_url}")
except Exception:
    print("‚úÖ –°—Ç—Ä–æ–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –Ω–∞–π–¥–µ–Ω–∞ (–Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–º–∞—Å–∫–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–æ–ª—å).")


# 3. –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
print("\n3. –ü—ã—Ç–∞–µ–º—Å—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å PostgreSQL –Ω–∞ Render...")
try:
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤ 10 —Å–µ–∫—É–Ω–¥
    conn = psycopg2.connect(db_url, connect_timeout=10)
    print("\n======================================================")
    print("üéâüéâüéâ –£–°–ü–ï–•! –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!")
    print("======================================================")
    conn.close()
    print("\n–í—ã–≤–æ–¥: –ü—Ä–æ–±–ª–µ–º–∞ –ù–ï –≤ –¥–æ—Å—Ç—É–ø–µ –∫ –ë–î, –∞ –≤ —Ç–æ–º, –∫–∞–∫ –µ–µ –≤—ã–∑—ã–≤–∞–µ—Ç –∫–æ–¥ FastAPI.")

except Exception as e:
    print("\n======================================================")
    print("‚ùå‚ùå‚ùå –ü–†–û–í–ê–õ! –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.")
    print("======================================================")
    print("\n–û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞:", e)
    print("\n--- –ß—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç –∏ —á—Ç–æ –¥–µ–ª–∞—Ç—å? ---")
    print("1. –°–∞–º–∞—è —á–∞—Å—Ç–∞—è –ø—Ä–∏—á–∏–Ω–∞: –≤–∞—à IP-–∞–¥—Ä–µ—Å –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω –≤ 'Allowed IP Addresses' –Ω–∞ Render. –û—Ç–∫—Ä–æ–π—Ç–µ Render, –Ω–∞–π–¥–∏—Ç–µ –≤–∞—à—É –ë–î, —Ä–∞–∑–¥–µ–ª 'Access' –∏ –¥–æ–±–∞–≤—å—Ç–µ —Å–≤–æ–π —Ç–µ–∫—É—â–∏–π IP.")
    print("2. –ü–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ö–ê–ñ–î–´–ô –°–ò–ú–í–û–õ –≤ —Å—Ç—Ä–æ–∫–µ DATABASE_URL –≤ –≤–∞—à–µ–º .env —Ñ–∞–π–ª–µ. –î–∞–∂–µ –æ–¥–∏–Ω –ª–∏—à–Ω–∏–π –ø—Ä–æ–±–µ–ª –≤—Å–µ —Å–ª–æ–º–∞–µ—Ç.")
    print("3. –†–µ–¥–∫–æ, –Ω–æ –≤–æ–∑–º–æ–∂–Ω–æ: –≤–∞—à –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–ø—Ä–æ–≤–∞–π–¥–µ—Ä, –∞–Ω—Ç–∏–≤–∏—Ä—É—Å –∏–ª–∏ firewall –±–ª–æ–∫–∏—Ä—É–µ—Ç –∏—Å—Ö–æ–¥—è—â–µ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–∞ –ø–æ—Ä—Ç 5432.")

print("\n--- –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ ---")